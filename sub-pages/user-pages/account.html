<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account | BoostInvest</title>
    <link rel="stylesheet" href="../user-pages/css/styles.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
<style>
    /* Global Styles */
    :root {
        --primary-gradient: linear-gradient(135deg, #1a2a6c 0%, #2c3e50 100%);
        --glass-bg: rgba(255, 255, 255, 0.95);
        --shadow-soft: 0 8px 30px rgba(0,0,0,0.08);
    }

    body { 
        padding-bottom: 90px; 
        background-color: #f8fafc; 
        font-family: 'Poppins', sans-serif;
    }

    .asset-card {
        background: var(--primary-gradient);
        color: white; 
        padding: 35px 20px; 
        border-radius: 24px; 
        margin-top: 20px;
        box-shadow: 0 15px 35px rgba(26, 42, 108, 0.2); 
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .total-balance { 
        font-size: clamp(2rem, 8vw, 2.8rem); 
        font-weight: 700; 
        margin: 10px 0;
    }

    .asset-details {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        border-top: 1px solid rgba(255,255,255,0.15);
        padding-top: 20px;
        margin-top: 20px;
    }

    .account-actions { 
        display: grid; 
        grid-template-columns: repeat(3, 1fr); 
        gap: 12px; 
        margin: 20px 0; 
    }

    .action-btn {
        background: #fff; 
        padding: 18px 10px; 
        border-radius: 18px; 
        text-align: center;
        text-decoration: none; 
        color: #1e293b; 
        font-weight: 600; 
        box-shadow: var(--shadow-soft);
        transition: 0.3s;
    }

    .account-grid { 
        display: grid; 
        grid-template-columns: 1.5fr 1fr; 
        gap: 20px; 
        margin-top: 20px; 
    }

    .profile-card, .kyc-card { 
        background: #fff; 
        padding: 25px; 
        border-radius: 20px; 
        box-shadow: var(--shadow-soft);
    }

    .card-title {
        display: flex; align-items: center; gap: 10px;
        font-size: 1.1rem; font-weight: 700;
        margin-bottom: 20px; border-bottom: 1px solid #f1f5f9;
        padding-bottom: 10px;
    }

    .status-badge { 
        background: #fef3c7; color: #92400e; 
        padding: 4px 10px; border-radius: 8px; 
        font-size: 0.7rem;
    }

    /* KYC Styles */
    .kyc-upload-box {
        border: 2px dashed #cbd5e1; 
        padding: 15px; 
        border-radius: 12px; 
        text-align: center; 
        margin-bottom: 15px;
        cursor: pointer;
    }
    .kyc-upload-box input { display: none; }
    .file-name { font-size: 0.75rem; color: #1a2a6c; margin-top: 5px; font-weight: 600; }

    .btn-submit-kyc {
        background: var(--primary-gradient);
        color: white; border: none; width: 100%;
        padding: 12px; border-radius: 10px; font-weight: 600;
        cursor: pointer;
    }

    .spinner {
        display: inline-block; width: 16px; height: 16px; 
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%; border-top-color: #fff; 
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading { opacity: 0.7; pointer-events: none; }

    @media (max-width: 768px) {
        .account-grid { grid-template-columns: 1fr; }
    }
</style>
</head>
<body>

    <header class="main-header">
        <div class="container header-content">
            <div class="logo-name">
                <img src="../logo.png" alt="logo" width="35px">
                <h1 class="logo">BoostInvest</h1>
            </div>
            <div class="auth-buttons">
                <a href="#" class="btn btn-secondary" id="copy-id-btn">
                    ID: <span id="user-id-display">...</span>
                </a>
                <a href="#" class="btn btn-signin" id="logout-btn">Log Out</a>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="asset-card">
            <span class="balance-label">Current Balance</span>
            <h2 class="total-balance" id="acc-balance">$0.00</h2>
            <div class="asset-details">
                <div class="asset-info"><h4>Package</h4><p id="acc-active-pkg">None</p></div>
                <div class="asset-info"><h4>Daily</h4><p id="acc-earnings">+$0.00</p></div>
                <div class="asset-info"><h4>Joined</h4><p id="acc-date">...</p></div>
            </div>
        </section>

        <div class="account-actions">
            <a href="./deposit.html" class="action-btn"><i class="fas fa-wallet"></i> Deposit</a>
            <a href="./withdraw.html" class="action-btn"><i class="fas fa-arrow-up"></i> Withdraw</a>
            <a href="./transaction.html" class="action-btn"><i class="fas fa-history"></i> History</a>
        </div>

        <div class="account-grid">
            <div class="profile-card">
                <h3 class="card-title"><i class="fas fa-user-circle"></i> Profile</h3>
                <div class="info-group"><label>Full Name</label><p id="prof-name">...</p></div>
                <div class="info-group"><label>Email</label><p id="prof-email">...</p></div>
                <div class="info-group"><label>Country</label><p id="prof-country">...</p></div>
            </div>

            <div class="kyc-card">
                <h3 class="card-title">
                    <i class="fas fa-shield-check"></i> KYC: 
                    <span class="status-badge" id="prof-kyc">Pending</span>
                </h3>
                
                <form id="kyc-form">
                    <div class="info-group">
                        <label>Full Legal Name</label>
                        <input type="text" id="kyc-fullname" placeholder="Sida ID-ga ku qoran" required style="width:100%; padding:8px; border:1px solid #ddd; border-radius:8px;">
                    </div>
                    <div class="kyc-upload-box" onclick="document.getElementById('selfie-upload').click()">
                        <label><i class="fas fa-camera"></i> Selfie Photo</label>
                        <input type="file" id="selfie-upload" accept="image/*" required>
                        <div class="file-name" id="selfie-name">No file chosen</div>
                    </div>
                    <div class="kyc-upload-box" onclick="document.getElementById('id-upload').click()">
                        <label><i class="fas fa-id-card"></i> National ID</label>
                        <input type="file" id="id-upload" accept="image/*" required>
                        <div class="file-name" id="id-name">No file chosen</div>
                    </div>
                    <button type="submit" class="btn-submit-kyc" id="submit-kyc-btn">Submit Verification</button>
                </form>

                <div id="kyc-completed-msg" style="display:none; text-align:center; padding:20px;">
                    <i class="fas fa-clock" style="font-size:2rem; color:#f59e0b;"></i>
                    <p style="margin-top:10px; font-weight:600;">Codsigaaga waa la soo diray. Sug admin-ka.</p>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { supabase } from './js/supabases.js';

        document.addEventListener("DOMContentLoaded", async function() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { window.location.href = '../sub-pages/signin.html'; return; }

            // 1. Fetch User Data & KYC Status
            async function loadData() {
                const { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).single();
                if (profile) {
                    document.getElementById('prof-name').textContent = profile.full_name;
                    document.getElementById('prof-email').textContent = profile.email;
                    document.getElementById('prof-kyc').textContent = profile.kyc_status;
                    
                    // Haddii uu hore u soo diray ama la xaqiijiyay, qari foomka
                    if (profile.kyc_status !== 'Pending') {
                        document.getElementById('kyc-form').style.display = 'none';
                        document.getElementById('kyc-completed-msg').style.display = 'block';
                    }
                }
                
                const { data: acc } = await supabase.from('accounts').select('*').eq('id', user.id).single();
                if (acc) document.getElementById('acc-balance').textContent = `$${acc.account_balance}`;
            }
            loadData();

            // 2. File Input Names
            document.getElementById('selfie-upload').onchange = (e) => document.getElementById('selfie-name').textContent = e.target.files[0].name;
            document.getElementById('id-upload').onchange = (e) => document.getElementById('id-name').textContent = e.target.files[0].name;

            // 3. KYC Submission Logic
            const kycForm = document.getElementById('kyc-form');
            kycForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('submit-kyc-btn');
                const fullName = document.getElementById('kyc-fullname').value;
                const selfieFile = document.getElementById('selfie-upload').files[0];
                const idFile = document.getElementById('id-upload').files[0];

                try {
                    btn.classList.add('loading');
                    btn.innerHTML = `<span class="spinner"></span> Dirista xogta...`;

                    // Function for upload
                    const upload = async (file, path) => {
                        const ext = file.name.split('.').pop();
                        const filePath = `${user.id}/${path}_${Date.now()}.${ext}`;
                        const { error } = await supabase.storage.from('kyc-documents').upload(filePath, file);
                        if (error) throw error;
                        return filePath;
                    };

                    const selfiePath = await upload(selfieFile, 'selfie');
                    const idPath = await upload(idFile, 'national_id');

                    // Insert to kyc_submissions
                    const { error: insErr } = await supabase.from('kyc_submissions').insert([{
                        profile_id: user.id,
                        full_name_legal: fullName,
                        user_photo_url: selfiePath,
                        id_card_photo_url: idPath,
                        status: 'pending'
                    }]);
                    if (insErr) throw insErr;

                    // Update profile status
                    await supabase.from('profiles').update({ kyc_status: 'Under Review' }).eq('id', user.id);

                    alert("Si guul leh ayaa loo soo diray!");
                    location.reload();
                } catch (err) {
                    alert("Khalad: " + err.message);
                    btn.classList.remove('loading');
                    btn.innerHTML = "Submit Verification";
                }
            });

            // Logout
            document.getElementById('logout-btn').onclick = () => supabase.auth.signOut().then(() => window.location.href = '../sub-pages/signin.html');
        });
    </script>
</body>
</html>