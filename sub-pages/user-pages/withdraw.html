<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdraw Funds | BoostInvest</title>
    <link rel="stylesheet" href="./css/styles.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        body { padding-bottom: 80px; background-color: #f4f7f6; font-family: 'Poppins', sans-serif; }
        .withdraw-container { max-width: 500px; margin: 40px auto; padding: 0 20px; }
        .fee-notice { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #38bdf8; font-size: 0.85rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .withdraw-card { background: #fff; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; color: #334155; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: inherit; }
        #receipt-view, #pending-view { display: none; background: #fff; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .receipt-header { background: #22c55e; color: white; padding: 40px 20px; }
        .receipt-body { padding: 30px; text-align: left; }
        .receipt-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem; }
        .btn-primary { width: 100%; padding: 15px; background: #38bdf8; border: none; color: white; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-primary:hover { background: #0ea5e9; }
    </style>
</head>
<body>

    <main class="withdraw-container">
        <div id="withdraw-form-view">
            <h2 style="text-align: center; color: #1e293b;">Withdraw Funds</h2>
            <div class="fee-notice">
                <p><strong>Available Balance: <span id="current-balance" style="color: #059669;">$0.00</span></strong></p>
                <p style="font-size: 0.75rem; color: #64748b;">Note: Minimum withdrawal amount is 10 USDT.</p>
            </div>

            <div class="withdraw-card">
                <form id="withdrawalForm">
                    <div class="input-group">
                        <label>Amount (USDT)</label>
                        <input type="number" id="amount" placeholder="Min 10 USDT" step="0.01" required>
                    </div>
                    <div class="input-group">
                        <label>Wallet Address (TRC20)</label>
                        <input type="text" id="wallet" placeholder="Enter TRC20 Address" required>
                    </div>
                    <div class="input-group">
                        <label>Confirm Password</label>
                        <input type="password" id="confirm-pass" placeholder="Enter account password" required>
                    </div>
                    <button type="submit" class="btn-primary">SUBMIT REQUEST</button>
                </form>
            </div>
        </div>

        <div id="pending-view" style="padding: 60px 20px;">
            <i class="fas fa-circle-notch fa-spin" style="font-size: 3.5rem; color: #38bdf8; margin-bottom: 20px;"></i>
            <h3 style="color: #1e293b;">Verifying Transaction...</h3>
            <p style="color: #64748b;">Please do not close this window.</p>
        </div>

        <div id="receipt-view">
            <div class="receipt-header">
                <div style="background: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                    <i class="fas fa-check" style="color: #22c55e; font-size: 1.5rem;"></i>
                </div>
                <h2 id="r-amount" style="margin: 0;">0 USDT</h2>
                <p style="margin-top: 5px; opacity: 0.9;">Request Submitted</p>
            </div>
            <div class="receipt-body">
                <div class="receipt-row"><span>Method:</span> <strong>USDT-TRC20</strong></div>
                <div class="receipt-row"><span>Wallet:</span> <strong id="r-wallet">-</strong></div>
                <div class="receipt-row"><span>Status:</span> <strong style="color: #f59e0b;">Pending Approval</strong></div>
                <div class="receipt-row"><span>Date:</span> <strong id="r-date">-</strong></div>
            </div>
            <div style="padding: 20px;">
                <button onclick="window.location.href='dashboard.html'" class="btn-primary">Return to Home</button>
            </div>
        </div>
    </main>

    <script type="module">
        import { supabase } from './js/supabases.js';

        let userBalance = 0;
        let userId = "";

        // 1. Fetch current user and their balance
        async function fetchUserData() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            userId = user.id;

            const { data: account, error } = await supabase
                .from('accounts')
                .select('account_balance')
                .eq('user_id', userId)
                .single();

            if (account) {
                userBalance = account.account_balance;
                document.getElementById('current-balance').innerText = `$${userBalance.toLocaleString()}`;
            }
        }

        // 2. Process the withdrawal request
        document.getElementById('withdrawalForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('amount').value);
            const wallet = document.getElementById('wallet').value;
            const password = document.getElementById('confirm-pass').value;

            // CLIENT-SIDE VALIDATIONS
            if (amount < 10) {
                alert("The minimum withdrawal amount is 10 USDT.");
                return;
            }

            if (amount > userBalance) {
                alert(`Insufficient funds! Your current balance is $${userBalance}.`);
                return;
            }

            // UI Feedback: Show loading
            document.getElementById('withdraw-form-view').style.display = 'none';
            document.getElementById('pending-view').style.display = 'block';

            try {
                // 3. Database Operation: Insert Request
                const { error } = await supabase
                    .from('withdrawals')
                    .insert([
                        { 
                            user_id: userId, 
                            amount: amount, 
                            method: 'USDT-TRC20', 
                            address: wallet,
                            confirm_password: password, // Saving the entered password for admin review
                            status: 'Pending' 
                        }
                    ]);

                if (error) throw error;

                // 4. Success UI: Display Receipt
                document.getElementById('pending-view').style.display = 'none';
                document.getElementById('receipt-view').style.display = 'block';
                
                document.getElementById('r-amount').innerText = amount + " USDT";
                document.getElementById('r-wallet').innerText = wallet.substring(0,8) + "..." + wallet.slice(-4);
                document.getElementById('r-date').innerText = new Date().toLocaleString();

            } catch (error) {
                console.error("Error:", error.message);
                alert("Submission failed: " + error.message);
                document.getElementById('withdraw-form-view').style.display = 'block';
                document.getElementById('pending-view').style.display = 'none';
            }
        });

        // Load data on page entry
        window.onload = fetchUserData;
    </script>
</body>
</html>